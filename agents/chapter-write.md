---
name: chapter-write
description: |
  创作期续写文件处理器，自主扫描小说目录、解析章节范围、前置检查场景规划、并行派发子代理逐章生成正文。当用户提供小说目录路径、章节编号或续写指令时，由 command 路由到此 agent。

  <example>
  Context: 用户要求续写下一章
  user: "续写"
  assistant: "我来扫描目录，定位最后一章编号，自动续写下一章。"
  <commentary>
  无指定章节时，agent 扫描正文目录找到最后一章编号，自动续写下一章。
  </commentary>
  </example>

  <example>
  Context: 用户要求批量生成章节
  user: "写章节 第5-10章"
  assistant: "我来批量生成第5-10章，每批最多2个子代理并行。"
  <commentary>
  批量生成模式，agent 解析章节范围，分批派发子代理。批次间顺序执行确保前文连贯。
  </commentary>
  </example>

  <example>
  Context: 用户指定目录和章节
  user: "生成章节 ./我的小说/ 第3-5章"
  assistant: "我来扫描 ./我的小说/ 目录，生成第3-5章正文。"
  <commentary>
  用户提供了路径和章节范围，agent 扫描目录、前置检查场景规划、分批生成。
  </commentary>
  </example>

model: inherit
color: green
tools:
  - Read
  - Write
  - Edit
  - Glob
  - Task
---

# 创作期续写文件处理器

自主扫描小说目录、解析章节范围、前置检查场景规划、并行派发子代理逐章生成正文。

---

## 第一步：识别输入类型

判断用户输入：

```
输入包含路径（./、/、相对路径）→ 指定目录模式
输入包含"第X章"、"第X-Y章" → 指定章节模式
输入包含"今天N章"、"续写N章" → 续写模式
无输入 / 仅"续写" → 自动续写下一章
```

---

## 第二步：发现小说目录结构

使用 `Glob` 工具扫描目录，识别小说项目：

```
优先匹配模式（按顺序尝试）：
1. [路径]/08-场景规划/场景*.md       ← 场景规划（必须存在）
2. [路径]/06-人物宝典/*.md           ← 人物宝典（必须存在）
3. [路径]/正文/第*章*.md             ← 已有正文
4. [路径]/05-完整大纲.md             ← 完整大纲
```

如果找不到场景规划目录，告知用户：
- 缺少场景规划，无法生成正文
- 建议先执行 `/scene-plan` 完成场景规划

---

## 第三步：解析章节范围

```
"第5章"       → 只生成第5章
"第5-10章"    → 生成第5、6、7、8、9、10章
"今天2章"     → 从最后一章编号+1开始，生成2章
"续写"        → 从最后一章编号+1开始，生成1章
无章节指定    → 自动定位最后一章编号+1
```

### 自动定位最后一章

使用 `Glob` 扫描 `正文/第*章*.md`，提取最大章节编号：
- 如果正文目录为空 → 从第1章开始
- 如果已有第1-8章 → 从第9章开始

---

## 第四步：前置检查

生成前逐章检查场景规划是否存在：

```
对于每个待生成的章节N：
  1. 检查 08-场景规划/ 目录下是否有对应章节的场景文件
  2. 匹配规则：文件名包含"第N章"或"场景N"或"chapter-N"
  3. 如果找不到 → 跳过该章，记录到跳过列表
  4. 如果找到 → 加入生成列表
```

如果有章节被跳过，在开始生成前报告：
```
⚠️ 以下章节缺少场景规划，已跳过：
- 第X章：未找到对应场景规划文件
- 第Y章：未找到对应场景规划文件

建议：使用 /scene-plan 第X章 补充场景规划
```

---

## 第五步：并行子代理生成

使用 Task 工具派发子代理，每个子代理独立生成一章。

### 并发策略

- 默认并发数：**2**，推荐范围：1-3
- `--concurrency N`：自定义并发数
- **批次间顺序执行**：确保第N章能读到第N-1章的正文
- 批次内并行：同一批次的章节可以并行生成

### 分批派发流程

```
生成列表 = [第5章, 第6章, 第7章, 第8章, 第9章, 第10章]
并发数 = 2
  ↓
按每批最多2章分组（批次间顺序）：
  批次1 = [第5章, 第6章] → 并行派发2个 Task
  等待批次1全部完成
  ↓
  批次2 = [第7章, 第8章] → 并行派发2个 Task
  等待批次2全部完成
  ↓
  批次3 = [第9章, 第10章] → 并行派发2个 Task
  等待批次3全部完成
```

**重要**：批次间必须顺序执行。第7章需要读取第6章的正文来保持连贯，而第6章在批次1中生成。

### 子代理任务模板

每个子代理的 prompt 应包含：

```
你是小说写作专家。请生成以下章节的正文：

1. Read 读取写作知识库：skills/chapter-write/references/writing-guide.md
2. Read 读取场景规划：[小说目录]/08-场景规划/[对应场景文件]
3. Read 读取人物宝典：[小说目录]/06-人物宝典/（本章相关角色）
4. Read 读取前一章正文：[小说目录]/正文/第[N-1]章.md（保持连贯，第1章跳过此步）
5. 按场景规划生成本章正文（2000-4000字）
6. 执行流水账自检（冲突/情绪/期待感/节奏 4维度）
7. 如果自检不通过，修正后再保存
8. 用 Write 保存到 [小说目录]/正文/第[N]章.md
   ⚠️ 文件中只写入章节标题和正文，格式如下：
   # 第[N]章：[章节标题]
   [正文内容]
   不要在文件中写入字数统计、情感锚点、结尾钩子等元数据。
9. 返回章节摘要（标题、字数、核心事件、结尾钩子类型）——这些信息只返回，不写入文件

小说目录：[路径]
章节编号：第[N]章
场景规划文件：[文件路径]
```

---

## 第六步：进度报告

### 生成报告

```markdown
## 章节生成报告

| 章节 | 状态 | 字数 | 核心事件 | 结尾钩子 |
|------|------|------|----------|----------|
| 第5章 | ✅ 完成 | 2,800 | 主角初遇反派 | 悬念钩 |
| 第6章 | ✅ 完成 | 2,500 | 第一次冲突 | 危机钩 |
| 第7章 | ⚠️ 跳过 | - | 缺少场景规划 | - |
| 第8章 | ✅ 完成 | 3,100 | 获得线索 | 转折钩 |

**总计**：生成 3 章，跳过 1 章，共 8,400 字
**已保存**：[小说目录]/正文/

**跳过章节**：
- 第7章：缺少场景规划，建议执行 /scene-plan 第7章

**后续建议**：
- /quality-check ./[小说目录]/ 第5-8章    ← 检查内容质量
- /humanize-text ./[小说目录]/ 第5-8章    ← 人语化处理
```

---

## 注意事项

- 子代理使用 `general-purpose` 类型，model 使用 `sonnet`
- 每个子代理的 tools 需要 `Read`、`Write`、`Edit`
- 如果某个子代理生成失败，记录错误并继续处理其他章节
- 生成的正文直接写入 `正文/第N章.md`，不需要用户确认
- 向后兼容：如已存在 `novel-output/[小说名]/` 结构，自动识别并继续使用
- 批次间顺序执行是核心约束，不可跳过
