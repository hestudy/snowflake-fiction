# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

Snowflake Fiction 是一个 Claude Code 插件，提供完整的小说创作工具链。包含六个核心技能：

| 技能 | 用途 | 触发词 |
|------|------|--------|
| snowflake-fiction | 雪花写作法创作小说（编排器） | 写小说、创作故事、雪花法 |
| outline-concept | 故事构思（步骤1→2构思期） | 构思故事、验证创意、故事概念、帮我想一个故事 |
| character-design | 角色设计（步骤3→5→7人物深化链） | 角色设计、人物设计、新增角色、深化角色 |
| scene-plan | 场景规划（步骤8→9场景设计链） | 场景规划、规划场景、场景设计、场景清单、规划章节 |
| novel-review | 小说质量复核检查 | 小说复核、章节检查、一致性检查、质量检查 |
| humanize-text | AI文本人语化处理 | 人语化、去AI味、润色 |
| quality-check | 内容质量评估（冲突/情绪/期待感/节奏/钩子五维打分） | 质量检查、内容检查、综合评估、检查质量、小说质量 |
| novel-export | 导出各平台格式 | 导出小说、番茄格式、起点格式 |

## 目录结构

```
snowflake-fiction/
├── .claude-plugin/
│   ├── plugin.json           # 插件元数据
│   └── marketplace.json      # Marketplace 发布配置
├── agents/
│   └── outline-builder.md    # 大纲构建 agent（步骤4+6）
├── skills/
│   ├── snowflake-fiction/    # 雪花写作法主技能
│   │   ├── SKILL.md          # 技能定义（12步/15步流程）
│   │   └── references/       # 参考模板
│   │       ├── step-prompts.md              # 每步提示词
│   │       ├── character-template.md        # 人物卡片模板
│   │       ├── scene-template.md            # 场景规划模板
│   │       ├── export-format.md             # 导出格式说明
│   │       ├── long-novel-guide.md          # 长篇小说指南
│   │       └── million-word-webnovel-guide.md # 百万级网文指南
│   ├── novel-review/         # 小说复核技能
│   │   ├── SKILL.md          # 技能定义（子代理架构）
│   │   └── references/
│   │       ├── consistency-check-prompt.md  # 一致性检查提示词
│   │       ├── character-state-template.md  # 角色状态追踪
│   │       ├── timeline-template.md         # 时间线追踪
│   │       ├── foreshadowing-tracker.md     # 伏笔追踪
│   │       └── review-report-template.md    # 复核报告模板
│   ├── character-design/     # 角色设计技能（步骤3+5+7）
│   │   └── SKILL.md
│   ├── scene-plan/           # 场景规划技能（步骤8+9）
│   │   └── SKILL.md
│   ├── humanize-text/        # 人语化处理技能
│   │   └── SKILL.md
│   └── novel-export/         # 格式导出技能
│       └── SKILL.md
└── README.md                 # 使用文档
```

## 技能架构

### snowflake-fiction（雪花写作法）

支持三种模式：
- **短篇小说**（1-3万字）：12步流程
- **长篇小说**（10-50万字）：15步流程，多卷结构
- **百万级网文**（100万字+）：商业节奏设计，黄金三章、付费卡点、爽点密度

流程阶段：构思期 → 设计期 → 构建期 → 规划期 → 创作期 → 润色期 → 导出期

输出目录规则：直接在当前工作目录下创建 `[小说名]/`（不再创建 `novel-output/` 中间层）；向后兼容已有的 `novel-output/[小说名]/` 结构

### character-design（角色设计）

覆盖步骤3→5→7的人物深化链，可独立使用，也可被 snowflake-fiction 主流程调用。

- **步骤3**：一页纸人物卡片（核心设定、人物弧光、标志性元素）
- **步骤5**：人物背景故事（童年创伤、成长经历、性格形成根源）
- **步骤7**：人物宝典（七大分类的完整角色资料库）

支持三种模式：快速卡片（仅步骤3）、完整深化（步骤3→5→7）、局部更新（更新已有角色）

触发词：角色设计、人物设计、新增角色、深化角色、完善人物

### scene-plan（场景规划）

覆盖步骤8→9的场景设计链，可独立使用，也可被 snowflake-fiction 主流程调用。

- **步骤8**：场景清单（将大纲拆解为结构化场景列表，含冲突类型和节奏检查）
- **步骤9**：场景详细规划（每个场景的三要素展开，主动/被动模板）

支持三种模式：全量规划（步骤8→9）、局部规划（指定章节重跑）、仅生成清单（步骤8）

局部重跑时只更新指定章节文件，不影响其他章节的已有规划。

触发词：场景规划、规划场景、场景设计、场景清单、规划章节

### outline-builder（大纲构建 agent）

覆盖步骤4（一页纸大纲）和步骤6（四页纸完整大纲），是构建期的核心汇聚节点。

与 skill 的区别：agent 会**自主读取**项目目录中的所有已有文件（概念文件、人物卡片、背景故事），无需用户手动提供内容，综合生成逻辑自洽的大纲。

- **步骤4**：将五句式大纲扩展为一页纸大纲（400-600字，含场景/对话/情绪）
- **步骤6**：综合所有材料生成四页纸完整大纲（2000-3000字，含章节规划/伏笔清单/灾难事件标注）

支持：`--rebuild`（忽略已有大纲重新生成）、`--step4-only`（只生成一页纸大纲）

生成后自动执行一致性检查（人物行为、时间线、三幕结构、伏笔自洽）。

触发词：生成大纲、构建大纲、写大纲、大纲重建、重新生成大纲

### novel-review（小说复核）

**核心挑战**：长篇小说可能有数十万字，一次性加载所有内容会导致上下文溢出。

**解决方案**：使用子代理（Sub-agent）架构，将检查任务拆分为独立的小任务。

检查项目：
- 角色一致性：性格、对话、能力、关系
- 时间线：时间流逝、季节、年龄
- 设定一致性：能力体系、物品、地点、规则
- 大纲偏离：核心事件、支线、节奏
- 伏笔回收：埋设、回收、超期预警
- 文风一致性：视角、语言风格、AI痕迹

输出目录规则：在小说目录下创建 `review/` 子目录，包含追踪文件和报告

### humanize-text（人语化处理）

核心指标：
- 困惑度（Perplexity）：避免过于常见的词汇选择
- 爆发度（Burstiness）：句式长短交替，节奏变化

支持场景：小说对话、小红书、学术论文、商务邮件

### quality-check（内容质量评估）

从五个维度评估文本内容吸引力，定位问题段落，给出优先修改建议。

- **冲突强度**（25%）：是否有明确冲突，是否足够强烈
- **情绪密度**（25%）：角色情绪是否饱满，读者能否共情
- **期待感**（20%）：读者是否想继续看下去
- **节奏控制**（15%）：张弛是否得当
- **钩子设计**（15%）：开头是否抓人，结尾是否有悬念

不负责 AI 痕迹检测（→ humanize-text）和流水账检测（→ boring-detect）。

触发词：质量检查、内容检查、综合评估、检查质量、小说质量

### novel-export（格式导出）

支持平台：番茄小说、起点中文网、晋江文学城、知乎盐选、七猫小说、通用纯文本、Word

关键格式差异：
- 番茄：无缩进，回车分段，无空行
- 起点：首行缩进2字符（全角空格）

## 修改技能时的注意事项

1. **SKILL.md 格式**：文件开头需包含 YAML front matter（name、description、version）
2. **触发词同步**：修改 description 中的触发词时，确保 README.md 也同步更新
3. **references 引用**：SKILL.md 中引用的模板文件路径使用相对路径 `./references/xxx.md`
4. **人语化禁止词汇**：保持 humanize-text 中禁止词汇清单的一致性

## 推荐工作流

```
snowflake-fiction → novel-review → humanize-text → novel-export
      ↑                  ↓
      └── 根据反馈修改 ←─┘
```

完整创作流程：
- 规划阶段（一次性）：使用 snowflake-fiction 完成大纲规划
- 日常生产（循环）：生成初稿 → 复核检查 → 人语化 → 导出 → 发布
- 周期回顾（每10章）：全面质量检查，调整大纲
